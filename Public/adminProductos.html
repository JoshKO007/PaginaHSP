

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agregar Producto - Administrador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Iconos -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.25);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .loading-box {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      padding: 14px 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.92rem;
      color: var(--text-main);
    }

    .loading-spinner {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 3px solid #d1d5db;
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    :root {
      --accent: #0077cc;
      --accent-soft: rgba(0, 119, 204, 0.15);
      --bg-light: #f4f6fb;
      --card-bg: rgba(255, 255, 255, 0.86);
      --text-main: #111827;
      --text-soft: #6b7280;
      --radius-xl: 22px;
      --shadow-soft: 0 14px 40px rgba(15, 23, 42, 0.18);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 40px 16px;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #e0f2fe, #ffffff 50%, #e5e7eb);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      color: var(--text-main);
      overflow-x: hidden;
    }

    .admin-layout {
      width: 100%;
      max-width: 1120px;
      display: flex;
      gap: 26px;
      align-items: stretch;
      justify-content: center;
    }

    .card.card-list {
      max-width: 520px;
      flex: 1 1 0;
    }

    .card.card-form {
      max-width: 520px;
      flex: 1 1 0;
    }

    .productos-list {
      margin-top: 6px;
      max-height: 1050px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .producto-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(209, 213, 219, 0.7);
      margin-bottom: 8px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .producto-row:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.15);
      background: #ffffff;
    }

    .producto-main {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .producto-thumb {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      overflow: hidden;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
      color: #4b5563;
    }

    .producto-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: white;
    }

    .producto-text {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .producto-name {
      font-size: 0.94rem;
      font-weight: 600;
      color: var(--text-main);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .producto-meta {
      font-size: 0.78rem;
      color: var(--text-soft);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .producto-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 3px;
    }

    .producto-badge {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #15803d;
      white-space: nowrap;
    }

    .producto-badge.inactive {
      background: #fee2e2;
      color: #b91c1c;
    }

    .producto-badge.secondary {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .switch-field {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
    }

    .switch-label {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: 0.2s;
      border-radius: 999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.2s;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.35);
    }

    .switch input:checked + .slider {
      background-color: var(--accent);
    }

    .switch input:checked + .slider:before {
      transform: translateX(18px);
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: white;
      padding: 7px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.82rem;
      font-weight: 500;
      color: #374151;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .btn-secondary i {
      font-size: 0.78rem;
    }

    .btn-secondary:hover {
      background: #eff6ff;
      border-color: #93c5fd;
      box-shadow: 0 8px 18px rgba(59, 130, 246, 0.25);
      transform: translateY(-1px);
    }

    .btn-secondary:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
    }

    .card-form-editing h1::after {
      content: " (edici√≥n)";
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--accent);
    }

    /* Canvas de fondo */
    #bgCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.3;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 32px 26px 26px;
      backdrop-filter: blur(14px);
      border: 1px solid rgba(148, 163, 184, 0.35);
      animation: fadeIn 0.7s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .card-header-icon {
      width: 64px;
      height: 64px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      margin-bottom: 12px;
    }

    .card-header-icon i {
      font-size: 30px;
      color: var(--accent);
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .subtitle {
      font-size: 0.95rem;
      color: var(--text-soft);
    }

    form {
      margin-top: 10px;
    }

    .field {
      margin-bottom: 18px;
    }

    /* Caracter√≠sticas del producto */
    .caracteristicas-container {
      margin-top: 4px;
      padding: 12px 12px 8px 12px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .caracteristicas-list {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .caracteristica-item {
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: center;
    }
    .caracteristica-input {
      flex: 1 1 0;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      background: #fff;
      transition: border-color 0.2s;
    }
    .caracteristica-input:focus {
      border-color: var(--accent);
      outline: none;
    }
    .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: #f3f4f6;
      color: #b91c1c;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.14s, color 0.14s;
      padding: 0;
    }
    .btn-icon.btn-remove-caracteristica:hover {
      background: #fee2e2;
      color: #991b1b;
    }

    .select-field {
      margin-bottom: 18px;
    }

    .select-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .select-wrapper select {
      width: 100%;
      padding: 11px 38px 11px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.96rem;
      outline: none;
      background: rgba(255, 255, 255, 0.95);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
    }

    .select-wrapper select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      transform: translateY(-1px);
    }

    .select-chevron {
      position: absolute;
      right: 12px;
      pointer-events: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    .select-wrapper select:focus + .select-chevron i {
      color: var(--accent);
      transform: translateY(-1px);
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: var(--text-soft);
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.96rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      max-height: 180px;
    }

    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      transform: translateY(-1px);
    }

    .hint {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 3px;
    }

    .btn-primary {
      width: 100%;
      margin-top: 8px;
      padding: 11px 14px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      font-size: 0.98rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .btn-primary i {
      font-size: 0.9rem;
    }

    .btn-primary:hover {
      background: #005fa3;
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.45);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.3);
    }

    #cancelEditBtn {
      width: 100%;
      margin-top: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: rgba(255, 255, 255, 0.95);
      color: #374151;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    #cancelEditBtn i {
      font-size: 0.9rem;
    }

    #cancelEditBtn:hover {
      background: #f3f4f6;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.15);
      transform: translateY(-1px);
    }

    #cancelEditBtn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
    }

    .card-form-editing #cancelEditBtn {
      display: flex;
    }

    .footer-links {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }

    .footer-links a {
      color: var(--accent);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .footer-links a:hover {
      text-decoration: underline;
    }

    .status-text {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    @media (max-width: 900px) {
      .admin-layout {
        flex-direction: column;
        max-width: 640px;
      }

      .card.card-list,
      .card.card-form {
        max-width: 100%;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 24px 12px;
      }

      .card {
        padding: 24px 18px 20px;
      }

      h1 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>

<body>
  <!-- Fondo animado -->
  <canvas id="bgCanvas"></canvas>

  <div id="globalLoader" class="loading-overlay">
    <div class="loading-box">
      <div class="loading-spinner"></div>
      <span>Cargando, por favor espera‚Ä¶</span>
    </div>
  </div>

  <div class="admin-layout">
    <!-- LISTA DE PRODUCTOS -->
    <div class="card card-list">
      <div class="card-header">
        <div class="card-header-icon">
          <i class="fa-solid fa-boxes-stacked"></i>
        </div>
        <h1>Productos actuales</h1>
        <p class="subtitle">Administra los productos ya registrados y ed√≠talos cuando lo necesites.</p>
      </div>
      <div id="productosList" class="productos-list"></div>
    </div>

    <!-- FORMULARIO PRODUCTO -->
    <div class="card card-form">
      <div class="card-header">
        <div class="card-header-icon">
          <i class="fa-solid fa-box-open"></i>
        </div>
        <h1>Agregar Producto</h1>
        <p class="subtitle">Registra un nuevo producto para usarlo en el cat√°logo.</p>
      </div>

      <form id="formProducto">
        <div class="field">
          <label for="nombre">Nombre del producto</label>
          <input type="text" id="nombre" placeholder="Ej. Rayos X port√°til" required />
        </div>

        <div class="field">
          <label for="numeroModelo">N√∫mero de modelo</label>
          <input type="text" id="numeroModelo" placeholder="Ej. HF100, A-64, etc." required />
        </div>

        <div class="field select-field">
          <label for="marcaSelect">Marca</label>
          <div class="select-wrapper">
            <select id="marcaSelect" required>
              <option value="">Selecciona una marca</option>
            </select>
            <span class="select-chevron">
              <i class="fa-solid fa-chevron-down"></i>
            </span>
          </div>
          <p class="hint">Las marcas mostradas vienen de la tabla "marcas" en Supabase.</p>
        </div>

        <div class="field select-field">
          <label for="categoriaSelect">Categor√≠a</label>
          <div class="select-wrapper">
            <select id="categoriaSelect" required>
              <option value="">Selecciona una categor√≠a</option>
            </select>
            <span class="select-chevron">
              <i class="fa-solid fa-chevron-down"></i>
            </span>
          </div>
          <p class="hint">Las categor√≠as mostradas vienen de la tabla "categorias" en Supabase.</p>
        </div>

        <div class="field">
          <label for="descripcion">Descripci√≥n</label>
          <textarea id="descripcion" placeholder="Describe brevemente el producto..."></textarea>
        </div>

        <div class="field">
          <label>Caracter√≠sticas del producto</label>
          <div class="caracteristicas-container">
            <div id="caracteristicasList" class="caracteristicas-list"></div>
            <button type="button" id="addCaracteristicaBtn" class="btn-secondary" style="margin-top: 10px; width: 100%; justify-content: center;">
              <i class="fa-solid fa-plus"></i>
              Agregar caracter√≠stica
            </button>
          </div>
          <p class="hint">Puedes agregar tantas caracter√≠sticas como necesites. Las vac√≠as se ignorar√°n.</p>
        </div>

        <div class="field">
          <label for="imagen">Seleccionar imagen desde tu equipo</label>
          <input type="file" id="imagen" accept="image/*" />
        </div>

        <div class="field">
          <label>Vista previa de la imagen</label>
          <canvas id="previewCanvas" width="260" height="140" style="border-radius: 12px; border: 1px dashed #cbd5f5; background: rgba(255,255,255,0.9);"></canvas>
          <p class="hint">Selecciona una imagen.</p>
        </div>

        <div class="field">
          <div class="switch-field">
            <span class="switch-label">Producto activo</span>
            <label class="switch">
              <input type="checkbox" id="activoSwitch" checked />
              <span class="slider"></span>
            </label>
          </div>
          <p class="hint">Puedes desactivar un producto sin eliminarlo.</p>
        </div>

        <button type="submit" class="btn-primary">
          <i class="fa-solid fa-floppy-disk"></i>
          Guardar producto
        </button>

        <button type="button" id="cancelEditBtn">
          <i class="fa-solid fa-xmark"></i>
          Cancelar edici√≥n
        </button>
      </form>

      <div class="footer-links">
        <a href="admin.html">
          <i class="fa-solid fa-arrow-left"></i>
          Volver al panel
        </a>
        <span class="status-text">Los cambios se guardan en Supabase</span>
      </div>
    </div>
  </div>

  <script>
    // Fondo Canvas animado (igual estilo que otras p√°ginas)
    const bgCanvas = document.getElementById("bgCanvas");
    const bgCtx = bgCanvas.getContext("2d");

    function resizeCanvas() {
      bgCanvas.width = window.innerWidth;
      bgCanvas.height = window.innerHeight;
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    const circles = Array.from({ length: 40 }, () => ({
      x: Math.random() * bgCanvas.width,
      y: Math.random() * bgCanvas.height,
      r: Math.random() * 8 + 3,
      dx: (Math.random() - 0.5) * 0.4,
      dy: (Math.random() - 0.5) * 0.4,
      alpha: Math.random() * 0.45 + 0.15,
    }));

    function animateBg() {
      bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);

      circles.forEach((c) => {
        bgCtx.beginPath();
        bgCtx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        bgCtx.fillStyle = `rgba(0, 119, 204, ${c.alpha})`;
        bgCtx.fill();

        c.x += c.dx;
        c.y += c.dy;

        if (c.x < 0 || c.x > bgCanvas.width) c.dx *= -1;
        if (c.y < 0 || c.y > bgCanvas.height) c.dy *= -1;
      });

      requestAnimationFrame(animateBg);
    }

    animateBg();
  </script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://zgjzensxrftkwnojvjqw.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnanplbnN4cmZ0a3dub2p2anF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5OTIwNjgsImV4cCI6MjA4MDU2ODA2OH0.vPJBa0xwr90bYxbNr2jw9ZodJMglKdYUaGjQrnfzeTg";

    const IMGBB_API_KEY = "18d7825e6b190dcaac01e42053affc61";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const globalLoader = document.getElementById("globalLoader");
    let loadingCount = 0;

    function setLoading(isLoading) {
      if (!globalLoader) return;
      if (isLoading) {
        loadingCount++;
      } else {
        loadingCount = Math.max(loadingCount - 1, 0);
      }
      globalLoader.style.display = loadingCount > 0 ? "flex" : "none";
    }

    const form = document.getElementById("formProducto");
    const fileInput = document.getElementById("imagen");
    const previewCanvas = document.getElementById("previewCanvas");
    const previewCtx = previewCanvas.getContext("2d");

    const productosList = document.getElementById("productosList");
    const cardForm = document.querySelector(".card-form");
    const titleEl = cardForm.querySelector("h1");
    const subtitleEl = cardForm.querySelector(".subtitle");
    const submitBtn = cardForm.querySelector(".btn-primary");
    const activoSwitch = document.getElementById("activoSwitch");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const marcaSelect = document.getElementById("marcaSelect");
    const categoriaSelect = document.getElementById("categoriaSelect");
    const caracteristicasListEl = document.getElementById("caracteristicasList");
    const addCaracteristicaBtn = document.getElementById("addCaracteristicaBtn");

    let currentEditId = null;
    let currentEditImageUrl = null;

    let marcasCache = [];
    let categoriasCache = [];

    // --- PREVIEW IMAGEN ---
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) {
        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
          const scale = Math.min(
            previewCanvas.width / img.width,
            previewCanvas.height / img.height
          );
          const drawWidth = img.width * scale;
          const drawHeight = img.height * scale;
          const offsetX = (previewCanvas.width - drawWidth) / 2;
          const offsetY = (previewCanvas.height - drawHeight) / 2;
          previewCtx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    // --- Caracter√≠sticas: helpers y eventos ---
    function createCaracteristicaRow(texto = "") {
      if (!caracteristicasListEl) return;
      const row = document.createElement("div");
      row.className = "caracteristica-item";

      const input = document.createElement("input");
      input.type = "text";
      input.className = "caracteristica-input";
      input.placeholder = "Ej. Iluminaci√≥n LED";
      input.value = texto || "";

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "btn-icon btn-remove-caracteristica";
      removeBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      removeBtn.addEventListener("click", () => {
        caracteristicasListEl.removeChild(row);
      });

      row.appendChild(input);
      row.appendChild(removeBtn);
      caracteristicasListEl.appendChild(row);
    }

    function clearCaracteristicas() {
      if (!caracteristicasListEl) return;
      caracteristicasListEl.innerHTML = "";
    }

    function ensureAtLeastOneCaracteristicaRow() {
      if (!caracteristicasListEl) return;
      if (caracteristicasListEl.children.length === 0) {
        createCaracteristicaRow("");
      }
    }

    function getCaracteristicasFromForm() {
      if (!caracteristicasListEl) return [];
      const textos = [];
      caracteristicasListEl.querySelectorAll(".caracteristica-input").forEach((input) => {
        const value = input.value.trim();
        if (value) textos.push(value);
      });
      return textos;
    }

    if (addCaracteristicaBtn) {
      addCaracteristicaBtn.addEventListener("click", () => {
        createCaracteristicaRow("");
      });
    }

    // --- FILE ‚Üí BASE64 ---
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(",")[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // --- SUBIR A IMGBB ---
    async function uploadToImgbb(file) {
      const base64Image = await fileToBase64(file);
      const formData = new FormData();
      formData.append("image", base64Image);

      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: "POST",
        body: formData,
      });

      const data = await res.json();
      if (!data.success) throw new Error("Error subiendo imagen a imgBB");
      return data.data.url;
    }

    // --- SIGUIENTE ID ---
    async function getNextId() {
      const { data, error } = await supabase
        .from("productos")
        .select("id")
        .order("id", { ascending: false })
        .limit(1);

      if (error) {
        console.error(error);
        throw new Error("No se pudo obtener el √∫ltimo ID de productos");
      }

      if (!data || data.length === 0) return 1;
      return data[0].id + 1;
    }

    // --- CARGAR MARCAS Y CATEGOR√çAS PARA SELECTS ---
    async function loadMarcasYCategorias() {
      setLoading(true);
      try {
        // Marcas
        {
          const { data, error } = await supabase
            .from("marcas")
            .select("id, nombre, activa")
            .order("nombre", { ascending: true });

          if (!error && data) {
            marcasCache = data;
            marcaSelect.innerHTML = '<option value="">Selecciona una marca</option>';
            data.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.id;
              opt.textContent = m.nombre + (m.activa === false ? " (inactiva)" : "");
              marcaSelect.appendChild(opt);
            });
          } else if (error) {
            console.error("Error cargando marcas:", error);
          }
        }

        // Categor√≠as
        {
          const { data, error } = await supabase
            .from("categorias")
            .select("id, nombre, activa")
            .order("nombre", { ascending: true });

          if (!error && data) {
            categoriasCache = data;
            categoriaSelect.innerHTML = '<option value="">Selecciona una categor√≠a</option>';
            data.forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c.id;
              opt.textContent = c.nombre + (c.activa === false ? " (inactiva)" : "");
              categoriaSelect.appendChild(opt);
            });
          } else if (error) {
            console.error("Error cargando categor√≠as:", error);
          }
        }
      } finally {
        setLoading(false);
      }
    }

    // --- CARGAR PRODUCTOS ---
    async function loadProductos() {
      if (!productosList) return;
      setLoading(true);
      try {
        const { data, error } = await supabase
          .from("productos")
          .select("id, nombre, numero_modelo, marca_id, categoria_id, descripcion, imagen, activo")
          .order("id", { ascending: true });

        if (error) {
          console.error("Error cargando productos:", error);
          return;
        }

        productosList.innerHTML = "";

        data.forEach((p) => {
          const row = document.createElement("div");
          row.className = "producto-row";

          const main = document.createElement("div");
          main.className = "producto-main";

          const thumb = document.createElement("div");
          thumb.className = "producto-thumb";

          if (p.imagen && (p.imagen.startsWith("http://") || p.imagen.startsWith("https://"))) {
            const img = document.createElement("img");
            img.src = p.imagen;
            img.alt = p.nombre;
            thumb.appendChild(img);
          } else {
            thumb.textContent = (p.nombre || "?").charAt(0).toUpperCase();
          }

          const textWrap = document.createElement("div");
          textWrap.className = "producto-text";

          const nameEl = document.createElement("div");
          nameEl.className = "producto-name";
          nameEl.textContent = p.nombre || "(Sin nombre)";

          const metaEl = document.createElement("div");
          metaEl.className = "producto-meta";

          const marcaObj = marcasCache.find((m) => m.id === p.marca_id);
          const catObj = categoriasCache.find((c) => c.id === p.categoria_id);

          const marcaName = marcaObj ? marcaObj.nombre : (p.marca_id != null ? `Marca #${p.marca_id}` : "Sin marca");
          const catName = catObj ? catObj.nombre : (p.categoria_id != null ? `Cat. #${p.categoria_id}` : "Sin categor√≠a");

          metaEl.textContent = `${p.numero_modelo || "Modelo N/D"} ‚Ä¢ ${marcaName} ‚Ä¢ ${catName}`;

          const badgesWrap = document.createElement("div");
          badgesWrap.className = "producto-badges";

          const badgeActivo = document.createElement("span");
          badgeActivo.className = "producto-badge" + (p.activo === false ? " inactive" : "");
          badgeActivo.textContent = p.activo === false ? "Inactivo" : "Activo";
          badgesWrap.appendChild(badgeActivo);

          textWrap.appendChild(nameEl);
          textWrap.appendChild(metaEl);
          textWrap.appendChild(badgesWrap);

          main.appendChild(thumb);
          main.appendChild(textWrap);

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn-secondary";
          editBtn.innerHTML = '<i class="fa-solid fa-pen"></i><span>Editar</span>';
          editBtn.addEventListener("click", () => startEditProducto(p));

          row.appendChild(main);
          row.appendChild(editBtn);

          productosList.appendChild(row);
        });
      } finally {
        setLoading(false);
      }
    }

    function resetFormState() {
      currentEditId = null;
      currentEditImageUrl = null;
      if (activoSwitch) {
        activoSwitch.checked = true;
      }
      cardForm.classList.remove("card-form-editing");
      titleEl.textContent = "Agregar Producto";
      subtitleEl.textContent = "Registra un nuevo producto para usarlo en el cat√°logo.";
      submitBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i>\n          Guardar producto';
      form.reset();
      previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

      // Reponer opci√≥n por defecto en selects
      if (marcaSelect) marcaSelect.value = "";
      if (categoriaSelect) categoriaSelect.value = "";

      // Resetear caracter√≠sticas
      clearCaracteristicas();
      ensureAtLeastOneCaracteristicaRow();
    }

    async function startEditProducto(p) {
      currentEditId = p.id;
      currentEditImageUrl = p.imagen || null;
      if (activoSwitch) {
        activoSwitch.checked = p.activo !== false;
      }
      cardForm.classList.add("card-form-editing");
      titleEl.textContent = "Editar Producto";
      subtitleEl.textContent = "Actualiza los datos de un producto existente.";
      submitBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i>\n          Guardar cambios';

      document.getElementById("nombre").value = p.nombre || "";
      document.getElementById("numeroModelo").value = p.numero_modelo || "";
      document.getElementById("descripcion").value = p.descripcion || "";

      if (marcaSelect && p.marca_id != null) {
        marcaSelect.value = String(p.marca_id);
      }
      if (categoriaSelect && p.categoria_id != null) {
        categoriaSelect.value = String(p.categoria_id);
      }

      // Vista previa si hay imagen URL
      previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
      if (p.imagen && (p.imagen.startsWith("http://") || p.imagen.startsWith("https://"))) {
        const img = new Image();
        img.onload = () => {
          const scale = Math.min(
            previewCanvas.width / img.width,
            previewCanvas.height / img.height
          );
          const drawWidth = img.width * scale;
          const drawHeight = img.height * scale;
          const offsetX = (previewCanvas.width - drawWidth) / 2;
          const offsetY = (previewCanvas.height - drawHeight) / 2;
          previewCtx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
        };
        img.src = p.imagen;
      }

      // Cargar caracter√≠sticas desde Supabase
      clearCaracteristicas();
      try {
        const { data: caracts, error: caractsError } = await supabase
          .from("producto_caracteristicas")
          .select("texto, activo")
          .eq("producto_id", p.id)
          .order("id", { ascending: true });

        if (!caractsError && caracts && caracts.length > 0) {
          caracts.forEach((c) => {
            // opcionalmente podr√≠as filtrar por activo, pero aqu√≠ incluimos todos
            createCaracteristicaRow(c.texto || "");
          });
        } else {
          ensureAtLeastOneCaracteristicaRow();
        }
      } catch (e) {
        console.error("Error cargando caracter√≠sticas del producto:", e);
        ensureAtLeastOneCaracteristicaRow();
      }

      cardForm.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    if (cancelEditBtn) {
      cancelEditBtn.addEventListener("click", () => {
        resetFormState();
      });
    }

    // --- SUBMIT FORM ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nombre = document.getElementById("nombre").value.trim();
      const numeroModelo = document.getElementById("numeroModelo").value.trim();
      const descripcion = document.getElementById("descripcion").value.trim();
      const marcaIdValue = marcaSelect.value;
      const categoriaIdValue = categoriaSelect.value;
      const file = fileInput.files[0];

      if (!nombre) {
        alert("Escribe el nombre del producto.");
        return;
      }
      if (!numeroModelo) {
        alert("Escribe el n√∫mero de modelo.");
        return;
      }
      if (!marcaIdValue) {
        alert("Selecciona una marca.");
        return;
      }
      if (!categoriaIdValue) {
        alert("Selecciona una categor√≠a.");
        return;
      }

      if (!currentEditId && !file) {
        alert("Selecciona una imagen para el nuevo producto.");
        return;
      }

      // Obtener caracter√≠sticas del formulario
      const caracteristicasTexto = getCaracteristicasFromForm();

      try {
        setLoading(true);
        let imageUrl = currentEditImageUrl || null;
        const activo = activoSwitch ? !!activoSwitch.checked : true;

        if (file) {
          imageUrl = await uploadToImgbb(file);
        }

        const marca_id = parseInt(marcaIdValue, 10);
        const categoria_id = parseInt(categoriaIdValue, 10);

        if (currentEditId) {
          // Actualizar producto existente
          const { error } = await supabase
            .from("productos")
            .update({
              nombre,
              numero_modelo: numeroModelo,
              marca_id,
              categoria_id,
              descripcion,
              imagen: imageUrl,
              activo,
            })
            .eq("id", currentEditId);

          if (error) {
            console.error("Error al actualizar producto:", error);
            alert("Ocurri√≥ un error al actualizar el producto.");
            return;
          }

          // Sincronizar caracter√≠sticas (modo sencillo: borrar e insertar)
          const { error: delCaractsError } = await supabase
            .from("producto_caracteristicas")
            .delete()
            .eq("producto_id", currentEditId);

          if (delCaractsError) {
            console.error("Error al borrar caracter√≠sticas previas:", delCaractsError);
          }

          if (caracteristicasTexto.length > 0) {
            const caractsInsert = caracteristicasTexto.map((texto) => ({
              producto_id: currentEditId,
              texto,
              activo: true,
            }));

            const { error: insCaractsError } = await supabase
              .from("producto_caracteristicas")
              .insert(caractsInsert);

            if (insCaractsError) {
              console.error("Error al insertar caracter√≠sticas:", insCaractsError);
              alert("El producto se guard√≥, pero ocurri√≥ un error al guardar sus caracter√≠sticas.");
              // seguimos adelante para no bloquear
            }
          }

          alert("Producto actualizado correctamente ‚úîÔ∏è");
        } else {
          // Crear nuevo producto
          const newId = await getNextId();

          const { error } = await supabase.from("productos").insert([
            {
              id: newId,
              nombre,
              numero_modelo: numeroModelo,
              marca_id,
              categoria_id,
              descripcion,
              imagen: imageUrl,
              activo,
            },
          ]);

          if (error) {
            console.error("Error al insertar producto:", error);
            alert("Ocurri√≥ un error al guardar en la base de datos.");
            return;
          }

          if (caracteristicasTexto.length > 0) {
            const caractsInsert = caracteristicasTexto.map((texto) => ({
              producto_id: newId,
              texto,
              activo: true,
            }));

            const { error: insCaractsError } = await supabase
              .from("producto_caracteristicas")
              .insert(caractsInsert);

            if (insCaractsError) {
              console.error("Error al insertar caracter√≠sticas:", insCaractsError);
              alert("El producto se guard√≥, pero ocurri√≥ un error al guardar sus caracter√≠sticas.");
              // no hacemos return para que contin√∫e el flujo
            }
          }

          alert("Producto guardado correctamente üéâ");
        }

        await loadProductos();
        resetFormState();
      } catch (err) {
        console.error(err);
        alert("Ocurri√≥ un error. Consulta la consola.");
      } finally {
        setLoading(false);
      }
    });

    // Init
    (async () => {
      await loadMarcasYCategorias();
      await loadProductos();
      resetFormState();
    })();
  </script>
</body>
</html>